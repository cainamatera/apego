<!DOCTYPE html>
<html lang="pt-br">
<head>
    <%- include('partials/header', { titulo: 'Gestão de Casas - Apêgo' }) %>
</head>
<body>
    <%- include('partials/navbar') %>

    <main class="container">
        <div class="table-container">
            <h3>Gestão de Casas e Alugueis</h3>

            <% if (success) { %>
                <div class="mensagem-sucesso">
                    Aluguel registrado com sucesso!
                </div>
            <% } %>
            <% if (removido) { %>
                <div class="mensagem-sucesso">
                    Aluguel removido com sucesso! A casa está disponível novamente.
                </div>
            <% } %>
            <% if (casa_excluida) { %>
                <div class="mensagem-sucesso">
                    Casa excluída com sucesso do catálogo.
                </div>
            <% } %>
            <% if (error) { %>
                <div class="mensagem-erro">
                    Ocorreu um erro. Tente novamente.
                </div>
            <% } %>

            <table>
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Valor Mensal</th>
                        <th>Status</th>
                        <th>Duração</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <% casas.forEach(casa => { %>
                        <tr>
                            <td><%= casa.titulo %></td>
                            <td>
                                <%= parseFloat(casa.valor_mensal).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                            </td>
                            <td>
                                <% if (casa.status === 'alugada') { %>
                                    <span class="status-chip status-alugada">Alugada</span>
                                <% } else { %>
                                    <span class="status-chip status-disponivel">Disponível</span>
                                <% } %>
                            </td>
                            <td>
                                <% if (casa.status === 'alugada' && casa.duracaoEmMeses) { %>
                                    <%= casa.duracaoEmMeses %> <%= casa.duracaoEmMeses === 1 ? 'mês' : 'meses' %>
                                <% } else { %>
                                    -
                                <% } %>
                            </td>
                            <td class="acoes-cell">
                                <% if (casa.status === 'alugada') { %>
                                    <form action="/aluguel/remover" method="POST" onsubmit="return confirm('Tem a certeza que deseja cancelar este aluguel? Esta ação é permanente.');" class="acao-form">
                                        <input type="hidden" name="aluguel_id" value="<%= casa.aluguel_id %>">
                                        <input type="hidden" name="cliente_id" value="<%= casa.cliente_id %>">
                                        <input type="hidden" name="casa_id" value="<%= casa.id %>">
                                        <button type="submit" class="botao-acao botao-cancelar" title="Cancelar Aluguel">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                <% } else { %>
                                    <a href="/aluguel/<%= casa.id %>" class="botao-acao botao-alugar" title="Alugar Casa">
                                        <i class="fas fa-plus"></i>
                                    </a>
                                <% } %>
                                <a href="#" class="botao-acao botao-editar" title="Editar Casa">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                <form action="/casa/excluir/<%= casa.id %>" method="POST" onsubmit="return confirm('Tem a certeza ABSOLUTA que deseja excluir esta casa e todos os seus dados? Esta ação não pode ser desfeita.');" class="acao-form">
                                    <button type="submit" class="botao-acao botao-excluir" title="Excluir Casa">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </main>
</body>
</html>