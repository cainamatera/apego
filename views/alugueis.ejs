<!DOCTYPE html>
<html lang="pt-br">
<head>
    <%- include('partials/header', { titulo: 'Gestão de Casas - Apêgo' }) %>
</head>
<body>
    <%- include('partials/navbar') %>

    <main class="container-com-sidebar">
        <aside class="sidebar-filtros card-painel">
            <h4>Filtros</h4>
            <form action="/alugueis" method="GET">
                <div class="input-group">
                    <label for="status">Status</label>
                    <select name="status" id="status">
                        <option value="">Todos</option>
                        <option value="disponivel" <%= locals.filtros && filtros.status === 'disponivel' ? 'selected' : '' %>>Disponível</option>
                        <option value="alugada" <%= locals.filtros && filtros.status === 'alugada' ? 'selected' : '' %>>Alugada</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="valor_min">Valor Mínimo</label>
                    <input type="number" name="valor_min" id="valor_min" step="0.01" value="<%= locals.filtros && filtros.valor_min ? filtros.valor_min : '' %>">
                </div>

                <div class="input-group">
                    <label for="valor_max">Valor Máximo</label>
                    <input type="number" name="valor_max" id="valor_max" step="0.01" value="<%= locals.filtros && filtros.valor_max ? filtros.valor_max : '' %>">
                </div>

                <button type="submit" class="botao-filtrar">Filtrar</button>
            </form>
        </aside>

        <section class="conteudo-principal card-painel">
            <h3>Gestão de Casas e Alugueis</h3>

            <% if (locals.success) { %>
                <div class="mensagem-sucesso">
                    <%= success %>
                </div>
            <% } %>
            <% if (locals.removido) { %>
                <div class="mensagem-sucesso">
                    Aluguel removido com sucesso! A casa está disponível novamente.
                </div>
            <% } %>
            <% if (locals.casa_excluida) { %>
                <div class="mensagem-sucesso">
                    Casa excluída com sucesso do catálogo.
                </div>
            <% } %>
            <% if (locals.error) { %>
                <div class="mensagem-erro">
                    Ocorreu um erro. Tente novamente.
                </div>
            <% } %>

            <table>
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Valor Mensal</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <% casas.forEach(casa => { %>
                        <tr>
                            <td><%= casa.titulo %></td>
                            <td>
                                <%= parseFloat(casa.valor_mensal).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                            </td>
                            <td>
                                <% if (casa.status === 'alugada') { %>
                                    <span class="status-chip status-alugada">Alugada</span>
                                <% } else { %>
                                    <span class="status-chip status-disponivel">Disponível</span>
                                <% } %>
                            </td>
                            <td class="acoes-cell">
                                <% if (casa.status === 'alugada') { %>
                                    <form action="/aluguel/remover" method="POST" onsubmit="return confirm('Tem a certeza que deseja cancelar este aluguel? Esta ação é permanente.');" class="acao-form">
                                        <input type="hidden" name="aluguel_id" value="<%= casa.aluguel_id %>">
                                        <input type="hidden" name="cliente_id" value="<%= casa.cliente_id %>">
                                        <input type="hidden" name="casa_id" value="<%= casa.id %>">
                                        <button type="submit" class="botao-acao botao-cancelar" title="Cancelar Aluguel">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                    <a href="/aluguel/editar/<%= casa.aluguel_id %>" class="botao-acao botao-editar" title="Editar Aluguel">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                <% } else { %>
                                    <a href="/aluguel/<%= casa.id %>" class="botao-acao botao-alugar" title="Alugar Casa">
                                        <i class="fas fa-plus"></i>
                                    </a>
                                    <a href="/casa/editar/<%= casa.id %>" class="botao-acao botao-editar" title="Editar Casa">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                <% } %>
                                <form action="/casa/excluir/<%= casa.id %>" method="POST" onsubmit="return confirm('Tem a certeza ABSOLUTA que deseja excluir esta casa e todos os seus dados? Esta ação não pode ser desfeita.');" class="acao-form">
                                    <button type="submit" class="botao-acao botao-excluir" title="Excluir Casa">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </section>
    </main>
</body>
</html>